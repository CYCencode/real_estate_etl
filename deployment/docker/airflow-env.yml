# ============================================
# Airflow 共用環境變數配置
# 用於 Control VM 和 Worker VM
# ============================================

# === DAG 使用的環境變數 ===
PROJECT_ID=real-estate-202510
PG_USER=postgres
PG_HOST=10.19.112.3
PG_PORT=5432
PG_DATABASE=postgres

# === Airflow Core 設定 ===
AIRFLOW__CORE__EXECUTOR=CeleryExecutor
AIRFLOW__CORE__INTERNAL_API_URL=http://10.128.0.5:8793
AIRFLOW__CORE__LOAD_EXAMPLES=False
AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION=False
AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG=3
AIRFLOW__CORE__PARALLELISM=32
AIRFLOW__CORE__DAG_CONCURRENCY=16
AIRFLOW__CORE__DAGBAG_IMPORT_TIMEOUT=60 
AIRFLOW__CORE__MAX_ACTIVE_TASKS_PER_DAG=16
AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/dags
DAGS_FOLDER=/opt/airflow/dags

# === Database 設定 ===
# 注意：密碼會在 docker-compose 中從環境變數注入
AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://airflow:${AIRFLOW_PG_PASSWORD}@10.128.0.4:5432/airflow_metadata
AIRFLOW__DATABASE__SQL_ALCHEMY_POOL_SIZE=10
AIRFLOW__DATABASE__SQL_ALCHEMY_POOL_RECYCLE=1800
AIRFLOW__DATABASE__SQL_ALCHEMY_POOL_PRE_PING=True
AIRFLOW__DATABASE__SQL_ALCHEMY_MAX_OVERFLOW=20 

# === Celery 設定 ===
AIRFLOW__CELERY__BROKER_URL=redis://10.128.0.4:6379/0
AIRFLOW__CELERY__RESULT_BACKEND=redis://10.128.0.4:6379/1
AIRFLOW__CELERY__WORKER_CONCURRENCY=4
AIRFLOW__CELERY__TASK_TRACK_STARTED=True
AIRFLOW__CELERY__WORKER_PREFETCH_MULTIPLIER=1
AIRFLOW__CELERY__BROKER_CONNECTION_RETRY_ON_STARTUP=True
AIRFLOW__CELERY__OPERATION_TIMEOUT=10.0
AIRFLOW__CELERY__TASK_ACKS_LATE=False

# === Webserver 設定 ===
AIRFLOW__WEBSERVER__BASE_URL=http://localhost:8080
AIRFLOW__WEBSERVER__EXPOSE_CONFIG=True
AIRFLOW__WEBSERVER__WORKERS=2

# === Scheduler 設定 ===
AIRFLOW__SCHEDULER__MIN_FILE_PROCESS_INTERVAL=60
AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL=300
AIRFLOW__SCHEDULER__CATCHUP_BY_DEFAULT=False
AIRFLOW__SCHEDULER__SCHEDULER_HEARTBEAT_SEC=5
AIRFLOW__SCHEDULER__PARSING_PROCESSES=2 

# === Logging 設定（Local + GCS 雙寫）===
AIRFLOW__LOGGING__REMOTE_LOGGING=True
AIRFLOW__LOGGING__REMOTE_BASE_LOG_FOLDER=gs://real-estate-202510-etl-logs/logs
AIRFLOW__LOGGING__REMOTE_LOG_CONN_ID=google_cloud_default
AIRFLOW__LOGGING__LOGGING_LEVEL=INFO
AIRFLOW__LOGGING__FAB_LOGGING_LEVEL=WARNING
AIRFLOW__LOGGING__COLORED_CONSOLE_LOG=False
AIRFLOW__LOGGING__WORKER_LOG_SERVER_PORT=8793

# === API 設定 ===
AIRFLOW__API__AUTH_BACKENDS=airflow.api.auth.backend.basic_auth
AIRFLOW__API__ENABLE_EXPERIMENTAL_API=False